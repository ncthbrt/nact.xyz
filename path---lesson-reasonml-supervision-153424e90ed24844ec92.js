webpackJsonp([43207875905462],{398:function(n,s){n.exports={data:{allPostTitles:{edges:[{node:{frontmatter:{title:"Adapters",lesson:6,category:"reasonml",chapter:2,type:"lesson"},fields:{slug:"/adapters"}}},{node:{frontmatter:{title:"Decoders and Encoders",lesson:2,category:"reasonml",chapter:4,type:"lesson"},fields:{slug:"/decoders-and-encoders"}}},{node:{frontmatter:{title:"Actor Communication",lesson:2,category:"reasonml",chapter:2,type:"lesson"},fields:{slug:"/actor-communication"}}},{node:{frontmatter:{title:"Getting Started",lesson:2,category:"reasonml",chapter:1,type:"lesson"},fields:{slug:"/getting-started"}}},{node:{frontmatter:{title:"Logging and Monitoring",lesson:1,category:"reasonml",chapter:4,type:"lesson"},fields:{slug:"/logging-and-monitoring"}}},{node:{frontmatter:{title:"Introduction",lesson:1,category:"reasonml",chapter:1,type:"lesson"},fields:{slug:"/introduction"}}},{node:{frontmatter:{title:"Persist",lesson:1,category:"reasonml",chapter:3,type:"lesson"},fields:{slug:"/persist"}}},{node:{frontmatter:{title:"Hierarchy",lesson:4,category:"reasonml",chapter:2,type:"lesson"},fields:{slug:"/hierarchy"}}},{node:{frontmatter:{title:"Querying",lesson:3,category:"reasonml",chapter:2,type:"lesson"},fields:{slug:"/querying"}}},{node:{frontmatter:{title:"Snapshotting",lesson:2,category:"reasonml",chapter:3,type:"lesson"},fields:{slug:"/snapshotting"}}},{node:{frontmatter:{title:"Stateful Actors",lesson:1,category:"reasonml",chapter:2,type:"lesson"},fields:{slug:"/stateful-actors"}}},{node:{frontmatter:{title:"Supervision",lesson:5,category:"reasonml",chapter:2,type:"lesson"},fields:{slug:"/supervision"}}},{node:{frontmatter:{title:"Timeouts",lesson:3,category:"reasonml",chapter:3,type:"lesson"},fields:{slug:"/timeouts"}}}]},postBySlug:{html:'<p>Actor systems are often designed around the <em>let it crash</em> philosophy.\nThis thesis is motivated by a desire to reduce the amount of infrastructural code which often obfuscates domain logic. </p>\n<p>How on earthÂ do we achieve system resilience if we just let our actors crash? The answer lies in the hierarchy: parents supervise their children. If a child crashes, the parent actor has an opportunity to make a decision about what to the fault. Erlang was one of the first platforms to adopt this strategy for dealing with faults, and was used to achieve jaw dropping reliability when building out the Ericsson telephone exchanges (on the order of nine 9s of availability). </p>\n<p>Nact\'s supervision system works similar to that of Erlang. If a child crashes in nact, it is stopped by default. Specifying the <code>whenChildCrashes</code> option allows one to override the supervision policy. A custom supervision policy is a function which takes in the exception which was thrown, the message which was being processed at the time at which the fault occurred, and the context of the parent. The supervision policy returns a decision (which may be may be asynchronous). The available decisions are enumerated in the following table:</p>\n<table class=\'definitions\'>\n    <thead>\n      <tr>\n        <th align=\'left\'>Decision</th>\n        <th align=\'left\'>Effect</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td align=\'left\'>Stop</td>\n        <td align=\'left\'>Stops the faulted actor</td>\n      </tr>\n      <tr>\n        <td align=\'left\'>StopAll</td>\n        <td align=\'left\'>Stops the peers of the faulted actor</td>\n      </tr>\n      <tr>\n        <td align=\'left\'>Reset</td>\n        <td align=\'left\'>Resets the state of the faulted actor</td>\n      </tr>\n      <tr>\n        <td align=\'left\'>ResetAll</td>\n        <td align=\'left\'>Resets the state of the faulted actor\'s peers</td>\n      </tr>\n      <tr>\n        <td align=\'left\'>Resume</td>\n        <td align=\'left\'>Continue processing the next messages in the actor\'s mailbox</td>\n      </tr>\n      <tr>\n        <td align=\'left\'>Escalate</td>\n        <td align=\'left\'>Sends the fault to the grandparent of the faulted actor</td>\n      </tr>\n    </tbody>\n  </table>\n<p>Here is an example of a supervision policy which resets the faulted child each time:</p>\n<div class="gatsby-highlight">\n      <pre class="language-reason"><code><span class="token keyword">let</span> resetChild <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constructor variable">Reset</span> <span class="token operator">|</span><span class="token operator">></span> <span class="token class-name">Js</span><span class="token punctuation">.</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>resolve<span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Perhaps your fault is caused by a resource not being available yet. In that case, we don\'t want to continually restart the actor as that\'ll just waste precious CPU cycles. So we\'d change the supervision policy to delay the reset.</p>\n<p>Let us first define the delay function (we\'ll be using this a lot):</p>\n<div class="gatsby-highlight">\n      <pre class="language-reason"><code><span class="token keyword">let</span> delay <span class="token operator">=</span> <span class="token punctuation">(</span>ms<span class="token punctuation">)</span> <span class="token operator">=></span>\n  <span class="token class-name">Js</span><span class="token punctuation">.</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>make<span class="token punctuation">(</span>\n    <span class="token punctuation">(</span><span class="token operator">~</span>resolve<span class="token punctuation">,</span> <span class="token operator">~</span>reject <span class="token keyword">as</span> _<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Js</span><span class="token punctuation">.</span><span class="token class-name">Global</span><span class="token punctuation">.</span>setTimeout<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>@bs<span class="token punctuation">]</span> resolve<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> unit<span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">></span> ignore\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Now to define the actual supervision policy itself: </p>\n<div class="gatsby-highlight">\n      <pre class="language-reason"><code><span class="token keyword">let</span> resetAfterDelayOf <span class="token operator">=</span> <span class="token punctuation">(</span>duration<span class="token punctuation">,</span> err<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=></span>\n  delay<span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">></span> <span class="token class-name">Js</span><span class="token punctuation">.</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>then_<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Js</span><span class="token punctuation">.</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token constructor variable">Reset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Perhaps we are consuming an external service and are worried about rate limiting.\nIn that case, we can use the <code>useStatefulSupervisionPolicy</code> to define a supervision policy with more sophisticated behavior:</p>\n<div class="gatsby-highlight">\n      <pre class="language-reason"><code><span class="token keyword">let</span> resetFaultedChildWithExponentialDelayOf <span class="token operator">=</span> factor <span class="token operator">=></span> \n  useStatefulSupervisionPolicy<span class="token punctuation">(</span>\n    <span class="token punctuation">(</span>err<span class="token punctuation">,</span> state<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> delayDuration <span class="token operator">=</span> int_of_float<span class="token punctuation">(</span><span class="token number">2.0</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>float_of_int<span class="token punctuation">(</span>state <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*.</span>factor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">(</span>state<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> delay<span class="token punctuation">(</span>delayDuration<span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">></span> <span class="token class-name">Js</span><span class="token punctuation">.</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>then_<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Js</span><span class="token punctuation">.</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token constructor variable">Reset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      \n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/* Initial State */</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>The main difference between the code we had before and this new supervision policy, is the addition of the state parameter and\nthat now we return a <code>(\'state, Js.Promise.t(supervisionAction))</code> in response to an error.\nThe first element in the tuple is passed as the state to the next failure.</p>\n<p>Let us modify our contacts service from the previous example to actually use the supervision policy:</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token keyword">let</span> contactsService <span class="token operator">=</span>\n  <span class="token function">spawn</span><span class="token punctuation">(</span>\n    <span class="token operator">~</span>whenChildCrashes<span class="token punctuation">:</span> <span class="token function">resetFaultedChildWithExponentialDelayOf</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> milliseconds<span class="token punctuation">)</span>\n    system<span class="token punctuation">,</span>\n    <span class="token punctuation">(</span>children<span class="token punctuation">,</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> potentialChild <span class="token operator">=</span>\n        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>StringMap<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token operator">|</span> _ <span class="token operator">=</span><span class="token operator">></span> None\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      Js<span class="token punctuation">.</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>\n        <span class="token keyword">switch</span> potentialChild <span class="token punctuation">{</span>\n        <span class="token operator">|</span> <span class="token function">Some</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>\n          <span class="token function">dispatch</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          children\n        <span class="token operator">|</span> None <span class="token operator">=</span><span class="token operator">></span>\n          <span class="token keyword">let</span> child <span class="token operator">=</span> <span class="token function">createContactsService</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>self<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token function">dispatch</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          StringMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> child<span class="token punctuation">,</span> children<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    StringMap<span class="token punctuation">.</span>empty\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>',timeToRead:3,excerpt:"Actor systems are often designed around the  let it crash  philosophy.\nThis thesis is motivated by a desire to reduce the amount of...",frontmatter:{title:"Supervision",cover:"https://unsplash.it/400/300/?random?BoldMage",date:"11/12/2017",category:"reasonml",tags:["getting-started","nact","reasonml","nodejs"]},fields:{slug:"/supervision"}}},pathContext:{slug:"/supervision",category:"reasonml"}}}});
//# sourceMappingURL=path---lesson-reasonml-supervision-153424e90ed24844ec92.js.map