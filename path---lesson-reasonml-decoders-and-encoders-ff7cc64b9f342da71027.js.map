{"version":3,"sources":["webpack:///path---lesson-reasonml-decoders-and-encoders-ff7cc64b9f342da71027.js","webpack:///./.cache/json/lesson-reasonml-decoders-and-encoders.json"],"names":["webpackJsonp","391","module","exports","data","allPostTitles","edges","node","frontmatter","title","lesson","category","chapter","type","fields","slug","postBySlug","html","timeToRead","excerpt","cover","date","tags","pathContext"],"mappings":"AAAAA,cAAc,iBAERC,IACA,SAAUC,EAAQC,GCHxBD,EAAAC,SACAC,MACAC,eACAC,QAEAC,MACAC,aACAC,MAAA,WACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,gBAKAR,MACAC,aACAC,MAAA,wBACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,6BAKAR,MACAC,aACAC,MAAA,sBACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,2BAKAR,MACAC,aACAC,MAAA,kBACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,uBAKAR,MACAC,aACAC,MAAA,yBACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,8BAKAR,MACAC,aACAC,MAAA,eACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,oBAKAR,MACAC,aACAC,MAAA,UACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,eAKAR,MACAC,aACAC,MAAA,YACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,iBAKAR,MACAC,aACAC,MAAA,WACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,gBAKAR,MACAC,aACAC,MAAA,eACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,oBAKAR,MACAC,aACAC,MAAA,kBACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,uBAKAR,MACAC,aACAC,MAAA,cACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,mBAKAR,MACAC,aACAC,MAAA,WACAC,OAAA,EACAC,SAAA,WACAC,QAAA,EACAC,KAAA,UAEAC,QACAC,KAAA,iBAMAC,YACAC,KAAA,0mkBACAC,WAAA,EACAC,QAAA,iJACAX,aACAC,MAAA,wBACAW,MAAA,+CACAC,KAAA,aACAV,SAAA,WACAW,MACA,kBACA,OACA,SACA,iBAGAR,QACAC,KAAA,4BAIAQ,aACAR,KAAA,yBACAJ,SAAA","file":"path---lesson-reasonml-decoders-and-encoders-ff7cc64b9f342da71027.js","sourcesContent":["webpackJsonp([64463788176840],{\n\n/***/ 391:\n/***/ (function(module, exports) {\n\n\tmodule.exports = {\n\t\t\"data\": {\n\t\t\t\"allPostTitles\": {\n\t\t\t\t\"edges\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Adapters\",\n\t\t\t\t\t\t\t\t\"lesson\": 6,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/adapters\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Decoders and Encoders\",\n\t\t\t\t\t\t\t\t\"lesson\": 2,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 4,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/decoders-and-encoders\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Actor Communication\",\n\t\t\t\t\t\t\t\t\"lesson\": 2,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/actor-communication\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Getting Started\",\n\t\t\t\t\t\t\t\t\"lesson\": 2,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 1,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/getting-started\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Logging and Monitoring\",\n\t\t\t\t\t\t\t\t\"lesson\": 1,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 4,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/logging-and-monitoring\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Introduction\",\n\t\t\t\t\t\t\t\t\"lesson\": 1,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 1,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/introduction\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Persist\",\n\t\t\t\t\t\t\t\t\"lesson\": 1,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 3,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/persist\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Hierarchy\",\n\t\t\t\t\t\t\t\t\"lesson\": 4,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/hierarchy\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Querying\",\n\t\t\t\t\t\t\t\t\"lesson\": 3,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/querying\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Snapshotting\",\n\t\t\t\t\t\t\t\t\"lesson\": 2,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 3,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/snapshotting\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Stateful Actors\",\n\t\t\t\t\t\t\t\t\"lesson\": 1,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/stateful-actors\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Supervision\",\n\t\t\t\t\t\t\t\t\"lesson\": 5,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/supervision\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\t\"title\": \"Timeouts\",\n\t\t\t\t\t\t\t\t\"lesson\": 3,\n\t\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\t\"chapter\": 3,\n\t\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\t\"slug\": \"/timeouts\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t},\n\t\t\t\"postBySlug\": {\n\t\t\t\t\"html\": \"<h2 id=\\\"schema-evolution\\\"><a href=\\\"#schema-evolution\\\" aria-hidden=\\\"true\\\" class=\\\"anchor\\\"><svg aria-hidden=\\\"true\\\" height=\\\"16\\\" version=\\\"1.1\\\" viewBox=\\\"0 0 16 16\\\" width=\\\"16\\\"><path fill-rule=\\\"evenodd\\\" d=\\\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\\\"></path></svg></a>Schema evolution</h2>\\n<p>Evolution is a natural part of a systems lifecycle; requirements change, reality sets in and bugs are fixed.\\nAs a result, migrating data from one version to another is a normal part of running a system in production.</p>\\n<p>One approach to schema evolution is running some kind of batch job which upgrades the old types to the new in-place.\\nThis approach is not without its risks: if done without discipline, there is the chance of data loss and other unhappy happenstances. It also goes against the philosophy of data immutability. Another downside of this approach to migration is that due to  the behavior of stateful actors, an all or nothing migration would likely require downtime.  </p>\\n<p>An alternative approach which fits in with the idea of event sourcing and immutable data is lazy upgrades between schema versions</p>\\n<p>For example let us imagine we have versions <code>S</code><sub><code>1</code></sub>, <code>S</code><sub><code>2</code></sub> and <code>S</code><sub><code>3</code></sub> of a schema <code>S</code>. Messages <code>m</code><sub><code>1</code></sub> and <code>m</code><sub><code>2</code></sub> were persisted with <code>S</code><sub><code>1</code></sub>, while <code>m</code><sub><code>3</code></sub> was saved with <code>S</code><sub><code>2</code></sub>. We've made a change and are forced to use <code>S</code><sub><code>3</code></sub> of the schema. When replaying messages, all we need to do is define two functions: <code>S</code><sub><code>1</code></sub><code>=></code> <code>S</code><sub><code>2</code></sub> and <code>S</code><sub><code>2</code></sub><code>=></code> <code>S</code><sub><code>3</code></sub>. We apply <code>S</code><sub><code>2</code></sub><code>=></code> <code>S</code><sub><code>3</code></sub> to <code>m</code><sub><code>3</code></sub> to upgrade it to latest version of the <code>S</code>. For <code>m</code><sub><code>2,3</code></sub> we map <code>S</code><sub><code>1</code></sub><code>=></code> <code>S</code><sub><code>2</code></sub> then map from <code>S</code><sub><code>2</code></sub><code>=></code> <code>S</code><sub><code>3</code></sub> to complete the upgrade. Being able to support this strategy was the primary motivation for introducing decoders and encoders.</p>\\n<h2 id=\\\"persistent-actors-and-json\\\"><a href=\\\"#persistent-actors-and-json\\\" aria-hidden=\\\"true\\\" class=\\\"anchor\\\"><svg aria-hidden=\\\"true\\\" height=\\\"16\\\" version=\\\"1.1\\\" viewBox=\\\"0 0 16 16\\\" width=\\\"16\\\"><path fill-rule=\\\"evenodd\\\" d=\\\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\\\"></path></svg></a>Persistent Actors and JSON</h2>\\n<p>Nact uses JSON for persistence and message passing. This means that in the ReasonML implementation, it uses the underlying mapping of BuckleScript types to JavaScript as a crutch so that users don't immediately have to worry about serialization and deserialization. However this should very much be a concern when engineering a robust production grade system. </p>\\n<p>The <code>spawnPersistent</code> function includes a number of optional arguments, namely <code>~encoder</code>, <code>~stateEncoder</code>, <code>~decoder</code> and <code>~stateDecoder</code>. These functions decode <code>Js.Json.t</code> values into Reason types and encode Reason types into types of <code>Js.Json.t</code>. The decoders are well suited to performing schema evolution, while the encoders are useful for adding version information and creating a more stable persistent representation. </p>\\n<h2 id=\\\"cracking-the-code\\\"><a href=\\\"#cracking-the-code\\\" aria-hidden=\\\"true\\\" class=\\\"anchor\\\"><svg aria-hidden=\\\"true\\\" height=\\\"16\\\" version=\\\"1.1\\\" viewBox=\\\"0 0 16 16\\\" width=\\\"16\\\"><path fill-rule=\\\"evenodd\\\" d=\\\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\\\"></path></svg></a>Cracking the Code</h2>\\n<p>The <code>DaVinci_Decode</code> example below demonstrates how to deal with an enthusiastic but naïve coworker who a) thought that <a href=\\\"https://en.wikipedia.org/wiki/ROT13\\\">ROT<sub>13</sub></a> was a good encryption scheme and b) applied it <strong>everywhere</strong>. </p>\\n<p>In the example, version zero of the message protocol is ROT13 encoded and needs to be unscrambled before\\nit is processed by the actor. Version one is encoded in plain text.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-reason\\\"><code><span class=\\\"token comment\\\" spellcheck=\\\"true\\\">/* Rot13 code */</span>\\n<span class=\\\"token keyword\\\">let</span> a <span class=\\\"token operator\\\">=</span> <span class=\\\"token class-name\\\">Char</span><span class=\\\"token punctuation\\\">.</span>code<span class=\\\"token punctuation\\\">(</span><span class=\\\"token character string\\\">'a'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> toPositionInAlphabet <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>c<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token class-name\\\">Char</span><span class=\\\"token punctuation\\\">.</span>code<span class=\\\"token punctuation\\\">(</span>c<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">-</span> a<span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> fromPositionInAlphabet <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>c<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token class-name\\\">Char</span><span class=\\\"token punctuation\\\">.</span>unsafe_chr<span class=\\\"token punctuation\\\">(</span>c <span class=\\\"token operator\\\">+</span> a<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> rot13 <span class=\\\"token operator\\\">=</span> <span class=\\\"token class-name\\\">String</span><span class=\\\"token punctuation\\\">.</span>map<span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span>c<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span>toPositionInAlphabet<span class=\\\"token punctuation\\\">(</span>c<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">+</span> <span class=\\\"token number\\\">13</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">mod</span> <span class=\\\"token number\\\">26</span> <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> fromPositionInAlphabet<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">type</span> msg <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token punctuation\\\">.</span> <span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> int<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> string<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n\\n<span class=\\\"token comment\\\" spellcheck=\\\"true\\\">/* Encoders and Decoders */</span>\\n<span class=\\\"token keyword\\\">let</span> jsonDecoder <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>json<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span>\\n  <span class=\\\"token class-name\\\">Json</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token class-name\\\">Decode</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> json <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> field<span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">,</span> int<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> json <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> field<span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">,</span> string<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> decoder <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>json<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">let</span> msg <span class=\\\"token operator\\\">=</span> json <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> jsonDecoder<span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>version <span class=\\\"token operator\\\">==</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>version<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> rot13<span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>text<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>version<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>text<span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> encoder <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span>\\n  <span class=\\\"token class-name\\\">Json</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token class-name\\\">Encode</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token punctuation\\\">(</span>object_<span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">,</span> msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>version <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> int<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">,</span> msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>text <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> string<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">open</span> <span class=\\\"token constructor variable\\\">Nact</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token comment\\\" spellcheck=\\\"true\\\">/* Specify a concrete persistence engine here */</span>\\n<span class=\\\"token keyword\\\">let</span> system <span class=\\\"token operator\\\">=</span> start<span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">~</span>persistenceEngine<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> actor <span class=\\\"token operator\\\">=</span>\\n  spawnPersistent<span class=\\\"token punctuation\\\">(</span>\\n    <span class=\\\"token operator\\\">~</span>key<span class=\\\"token operator\\\">=</span><span class=\\\"token string\\\">\\\"da-vinci-code\\\"</span><span class=\\\"token punctuation\\\">,</span>    \\n    <span class=\\\"token comment\\\" spellcheck=\\\"true\\\">/* Decoder and encoder functions are specified here */</span>\\n    <span class=\\\"token operator\\\">~</span>decoder<span class=\\\"token punctuation\\\">,</span>    \\n    <span class=\\\"token operator\\\">~</span>encoder<span class=\\\"token punctuation\\\">,</span>\\n    system<span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">(</span>state<span class=\\\"token punctuation\\\">,</span> msg<span class=\\\"token punctuation\\\">,</span> ctx<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token class-name\\\">Js</span><span class=\\\"token punctuation\\\">.</span>log<span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>text<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token keyword\\\">let</span> nextState <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token class-name\\\">Js</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token class-name\\\">Promise</span><span class=\\\"token punctuation\\\">.</span>resolve<span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">[</span>msg<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token operator\\\">...</span>state<span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span> ctx<span class=\\\"token punctuation\\\">.</span>recovering<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        ctx<span class=\\\"token punctuation\\\">.</span>persist<span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> <span class=\\\"token class-name\\\">Js</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token class-name\\\">Promise</span><span class=\\\"token punctuation\\\">.</span>then_<span class=\\\"token punctuation\\\">(</span>nextState<span class=\\\"token punctuation\\\">)</span>\\n      <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n        nextState<span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span>\\n  <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">open</span> <span class=\\\"token class-name\\\">Nact</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token constructor variable\\\">Operators</span><span class=\\\"token punctuation\\\">;</span>\\n\\nactor <span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">&lt;</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"uryybjbeyq\\\"</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\nactor <span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">&lt;</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"the time has come\\\"</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\nactor <span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">&lt;</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"sbewblynhtugrenaqcyraglbssha\\\"</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\",\n\t\t\t\t\"timeToRead\": 3,\n\t\t\t\t\"excerpt\": \"Schema evolution Evolution is a natural part of a systems lifecycle; requirements change, reality sets in and bugs are fixed. \\nAs a result...\",\n\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\"title\": \"Decoders and Encoders\",\n\t\t\t\t\t\"cover\": \"https://unsplash.it/400/300/?random?BoldMage\",\n\t\t\t\t\t\"date\": \"28/01/2018\",\n\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\"tags\": [\n\t\t\t\t\t\t\"getting-started\",\n\t\t\t\t\t\t\"nact\",\n\t\t\t\t\t\t\"reason\",\n\t\t\t\t\t\t\"bucklescript\"\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t\"fields\": {\n\t\t\t\t\t\"slug\": \"/decoders-and-encoders\"\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t\"pathContext\": {\n\t\t\t\"slug\": \"/decoders-and-encoders\",\n\t\t\t\"category\": \"reasonml\"\n\t\t}\n\t};\n\n/***/ })\n\n});\n\n\n// WEBPACK FOOTER //\n// path---lesson-reasonml-decoders-and-encoders-ff7cc64b9f342da71027.js","module.exports = {\n\t\"data\": {\n\t\t\"allPostTitles\": {\n\t\t\t\"edges\": [\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Adapters\",\n\t\t\t\t\t\t\t\"lesson\": 6,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/adapters\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Decoders and Encoders\",\n\t\t\t\t\t\t\t\"lesson\": 2,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 4,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/decoders-and-encoders\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Actor Communication\",\n\t\t\t\t\t\t\t\"lesson\": 2,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/actor-communication\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Getting Started\",\n\t\t\t\t\t\t\t\"lesson\": 2,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 1,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/getting-started\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Logging and Monitoring\",\n\t\t\t\t\t\t\t\"lesson\": 1,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 4,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/logging-and-monitoring\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Introduction\",\n\t\t\t\t\t\t\t\"lesson\": 1,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 1,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/introduction\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Persist\",\n\t\t\t\t\t\t\t\"lesson\": 1,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 3,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/persist\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Hierarchy\",\n\t\t\t\t\t\t\t\"lesson\": 4,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/hierarchy\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Querying\",\n\t\t\t\t\t\t\t\"lesson\": 3,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/querying\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Snapshotting\",\n\t\t\t\t\t\t\t\"lesson\": 2,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 3,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/snapshotting\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Stateful Actors\",\n\t\t\t\t\t\t\t\"lesson\": 1,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/stateful-actors\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Supervision\",\n\t\t\t\t\t\t\t\"lesson\": 5,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 2,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/supervision\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"node\": {\n\t\t\t\t\t\t\"frontmatter\": {\n\t\t\t\t\t\t\t\"title\": \"Timeouts\",\n\t\t\t\t\t\t\t\"lesson\": 3,\n\t\t\t\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\t\t\t\"chapter\": 3,\n\t\t\t\t\t\t\t\"type\": \"lesson\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"fields\": {\n\t\t\t\t\t\t\t\"slug\": \"/timeouts\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t\"postBySlug\": {\n\t\t\t\"html\": \"<h2 id=\\\"schema-evolution\\\"><a href=\\\"#schema-evolution\\\" aria-hidden=\\\"true\\\" class=\\\"anchor\\\"><svg aria-hidden=\\\"true\\\" height=\\\"16\\\" version=\\\"1.1\\\" viewBox=\\\"0 0 16 16\\\" width=\\\"16\\\"><path fill-rule=\\\"evenodd\\\" d=\\\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\\\"></path></svg></a>Schema evolution</h2>\\n<p>Evolution is a natural part of a systems lifecycle; requirements change, reality sets in and bugs are fixed.\\nAs a result, migrating data from one version to another is a normal part of running a system in production.</p>\\n<p>One approach to schema evolution is running some kind of batch job which upgrades the old types to the new in-place.\\nThis approach is not without its risks: if done without discipline, there is the chance of data loss and other unhappy happenstances. It also goes against the philosophy of data immutability. Another downside of this approach to migration is that due to  the behavior of stateful actors, an all or nothing migration would likely require downtime.  </p>\\n<p>An alternative approach which fits in with the idea of event sourcing and immutable data is lazy upgrades between schema versions</p>\\n<p>For example let us imagine we have versions <code>S</code><sub><code>1</code></sub>, <code>S</code><sub><code>2</code></sub> and <code>S</code><sub><code>3</code></sub> of a schema <code>S</code>. Messages <code>m</code><sub><code>1</code></sub> and <code>m</code><sub><code>2</code></sub> were persisted with <code>S</code><sub><code>1</code></sub>, while <code>m</code><sub><code>3</code></sub> was saved with <code>S</code><sub><code>2</code></sub>. We've made a change and are forced to use <code>S</code><sub><code>3</code></sub> of the schema. When replaying messages, all we need to do is define two functions: <code>S</code><sub><code>1</code></sub><code>=></code> <code>S</code><sub><code>2</code></sub> and <code>S</code><sub><code>2</code></sub><code>=></code> <code>S</code><sub><code>3</code></sub>. We apply <code>S</code><sub><code>2</code></sub><code>=></code> <code>S</code><sub><code>3</code></sub> to <code>m</code><sub><code>3</code></sub> to upgrade it to latest version of the <code>S</code>. For <code>m</code><sub><code>2,3</code></sub> we map <code>S</code><sub><code>1</code></sub><code>=></code> <code>S</code><sub><code>2</code></sub> then map from <code>S</code><sub><code>2</code></sub><code>=></code> <code>S</code><sub><code>3</code></sub> to complete the upgrade. Being able to support this strategy was the primary motivation for introducing decoders and encoders.</p>\\n<h2 id=\\\"persistent-actors-and-json\\\"><a href=\\\"#persistent-actors-and-json\\\" aria-hidden=\\\"true\\\" class=\\\"anchor\\\"><svg aria-hidden=\\\"true\\\" height=\\\"16\\\" version=\\\"1.1\\\" viewBox=\\\"0 0 16 16\\\" width=\\\"16\\\"><path fill-rule=\\\"evenodd\\\" d=\\\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\\\"></path></svg></a>Persistent Actors and JSON</h2>\\n<p>Nact uses JSON for persistence and message passing. This means that in the ReasonML implementation, it uses the underlying mapping of BuckleScript types to JavaScript as a crutch so that users don't immediately have to worry about serialization and deserialization. However this should very much be a concern when engineering a robust production grade system. </p>\\n<p>The <code>spawnPersistent</code> function includes a number of optional arguments, namely <code>~encoder</code>, <code>~stateEncoder</code>, <code>~decoder</code> and <code>~stateDecoder</code>. These functions decode <code>Js.Json.t</code> values into Reason types and encode Reason types into types of <code>Js.Json.t</code>. The decoders are well suited to performing schema evolution, while the encoders are useful for adding version information and creating a more stable persistent representation. </p>\\n<h2 id=\\\"cracking-the-code\\\"><a href=\\\"#cracking-the-code\\\" aria-hidden=\\\"true\\\" class=\\\"anchor\\\"><svg aria-hidden=\\\"true\\\" height=\\\"16\\\" version=\\\"1.1\\\" viewBox=\\\"0 0 16 16\\\" width=\\\"16\\\"><path fill-rule=\\\"evenodd\\\" d=\\\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\\\"></path></svg></a>Cracking the Code</h2>\\n<p>The <code>DaVinci_Decode</code> example below demonstrates how to deal with an enthusiastic but naïve coworker who a) thought that <a href=\\\"https://en.wikipedia.org/wiki/ROT13\\\">ROT<sub>13</sub></a> was a good encryption scheme and b) applied it <strong>everywhere</strong>. </p>\\n<p>In the example, version zero of the message protocol is ROT13 encoded and needs to be unscrambled before\\nit is processed by the actor. Version one is encoded in plain text.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-reason\\\"><code><span class=\\\"token comment\\\" spellcheck=\\\"true\\\">/* Rot13 code */</span>\\n<span class=\\\"token keyword\\\">let</span> a <span class=\\\"token operator\\\">=</span> <span class=\\\"token class-name\\\">Char</span><span class=\\\"token punctuation\\\">.</span>code<span class=\\\"token punctuation\\\">(</span><span class=\\\"token character string\\\">'a'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> toPositionInAlphabet <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>c<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token class-name\\\">Char</span><span class=\\\"token punctuation\\\">.</span>code<span class=\\\"token punctuation\\\">(</span>c<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">-</span> a<span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> fromPositionInAlphabet <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>c<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token class-name\\\">Char</span><span class=\\\"token punctuation\\\">.</span>unsafe_chr<span class=\\\"token punctuation\\\">(</span>c <span class=\\\"token operator\\\">+</span> a<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> rot13 <span class=\\\"token operator\\\">=</span> <span class=\\\"token class-name\\\">String</span><span class=\\\"token punctuation\\\">.</span>map<span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span>c<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span>toPositionInAlphabet<span class=\\\"token punctuation\\\">(</span>c<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">+</span> <span class=\\\"token number\\\">13</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">mod</span> <span class=\\\"token number\\\">26</span> <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> fromPositionInAlphabet<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">type</span> msg <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token punctuation\\\">.</span> <span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> int<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> string<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n\\n<span class=\\\"token comment\\\" spellcheck=\\\"true\\\">/* Encoders and Decoders */</span>\\n<span class=\\\"token keyword\\\">let</span> jsonDecoder <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>json<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span>\\n  <span class=\\\"token class-name\\\">Json</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token class-name\\\">Decode</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> json <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> field<span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">,</span> int<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> json <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> field<span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">,</span> string<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> decoder <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>json<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">let</span> msg <span class=\\\"token operator\\\">=</span> json <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> jsonDecoder<span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>version <span class=\\\"token operator\\\">==</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>version<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> rot13<span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>text<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>version<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>text<span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> encoder <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span>\\n  <span class=\\\"token class-name\\\">Json</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token class-name\\\">Encode</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token punctuation\\\">(</span>object_<span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">,</span> msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>version <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> int<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">,</span> msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>text <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> string<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">open</span> <span class=\\\"token constructor variable\\\">Nact</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token comment\\\" spellcheck=\\\"true\\\">/* Specify a concrete persistence engine here */</span>\\n<span class=\\\"token keyword\\\">let</span> system <span class=\\\"token operator\\\">=</span> start<span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">~</span>persistenceEngine<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> actor <span class=\\\"token operator\\\">=</span>\\n  spawnPersistent<span class=\\\"token punctuation\\\">(</span>\\n    <span class=\\\"token operator\\\">~</span>key<span class=\\\"token operator\\\">=</span><span class=\\\"token string\\\">\\\"da-vinci-code\\\"</span><span class=\\\"token punctuation\\\">,</span>    \\n    <span class=\\\"token comment\\\" spellcheck=\\\"true\\\">/* Decoder and encoder functions are specified here */</span>\\n    <span class=\\\"token operator\\\">~</span>decoder<span class=\\\"token punctuation\\\">,</span>    \\n    <span class=\\\"token operator\\\">~</span>encoder<span class=\\\"token punctuation\\\">,</span>\\n    system<span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">(</span>state<span class=\\\"token punctuation\\\">,</span> msg<span class=\\\"token punctuation\\\">,</span> ctx<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token class-name\\\">Js</span><span class=\\\"token punctuation\\\">.</span>log<span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token operator\\\">#</span><span class=\\\"token operator\\\">#</span>text<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token keyword\\\">let</span> nextState <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token class-name\\\">Js</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token class-name\\\">Promise</span><span class=\\\"token punctuation\\\">.</span>resolve<span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">[</span>msg<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token operator\\\">...</span>state<span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span> ctx<span class=\\\"token punctuation\\\">.</span>recovering<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        ctx<span class=\\\"token punctuation\\\">.</span>persist<span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">|</span><span class=\\\"token operator\\\">></span> <span class=\\\"token class-name\\\">Js</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token class-name\\\">Promise</span><span class=\\\"token punctuation\\\">.</span>then_<span class=\\\"token punctuation\\\">(</span>nextState<span class=\\\"token punctuation\\\">)</span>\\n      <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n        nextState<span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span>\\n  <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">open</span> <span class=\\\"token class-name\\\">Nact</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token constructor variable\\\">Operators</span><span class=\\\"token punctuation\\\">;</span>\\n\\nactor <span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">&lt;</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"uryybjbeyq\\\"</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\nactor <span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">&lt;</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"the time has come\\\"</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\nactor <span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">-</span><span class=\\\"token operator\\\">&lt;</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">\\\"version\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"text\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"sbewblynhtugrenaqcyraglbssha\\\"</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\",\n\t\t\t\"timeToRead\": 3,\n\t\t\t\"excerpt\": \"Schema evolution Evolution is a natural part of a systems lifecycle; requirements change, reality sets in and bugs are fixed. \\nAs a result...\",\n\t\t\t\"frontmatter\": {\n\t\t\t\t\"title\": \"Decoders and Encoders\",\n\t\t\t\t\"cover\": \"https://unsplash.it/400/300/?random?BoldMage\",\n\t\t\t\t\"date\": \"28/01/2018\",\n\t\t\t\t\"category\": \"reasonml\",\n\t\t\t\t\"tags\": [\n\t\t\t\t\t\"getting-started\",\n\t\t\t\t\t\"nact\",\n\t\t\t\t\t\"reason\",\n\t\t\t\t\t\"bucklescript\"\n\t\t\t\t]\n\t\t\t},\n\t\t\t\"fields\": {\n\t\t\t\t\"slug\": \"/decoders-and-encoders\"\n\t\t\t}\n\t\t}\n\t},\n\t\"pathContext\": {\n\t\t\"slug\": \"/decoders-and-encoders\",\n\t\t\"category\": \"reasonml\"\n\t}\n};\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/json-loader!./.cache/json/lesson-reasonml-decoders-and-encoders.json\n// module id = 391\n// module chunks = 64463788176840"],"sourceRoot":""}