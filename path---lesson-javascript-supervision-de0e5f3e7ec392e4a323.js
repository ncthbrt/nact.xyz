webpackJsonp([0xf2ac3b7bde86],{390:function(n,s){n.exports={data:{allPostTitles:{edges:[{node:{frontmatter:{title:"Supervision",lesson:5,category:"javascript",chapter:2,type:"lesson"},fields:{slug:"/supervision"}}},{node:{frontmatter:{title:"Actor Communication",lesson:2,category:"javascript",chapter:2,type:"lesson"},fields:{slug:"/actor-communication"}}},{node:{frontmatter:{title:"Hierarchy",lesson:4,category:"javascript",chapter:2,type:"lesson"},fields:{slug:"/hierarchy"}}},{node:{frontmatter:{title:"Getting Started",lesson:2,category:"javascript",chapter:1,type:"lesson"},fields:{slug:"/getting-started"}}},{node:{frontmatter:{title:"Introduction",lesson:1,category:"javascript",chapter:1,type:"lesson"},fields:{slug:"/introduction"}}},{node:{frontmatter:{title:"Snapshotting",lesson:2,category:"javascript",chapter:3,type:"lesson"},fields:{slug:"/snapshotting"}}},{node:{frontmatter:{title:"Persist",lesson:1,category:"javascript",chapter:3,type:"lesson"},fields:{slug:"/persist"}}},{node:{frontmatter:{title:"Stateful Actors",lesson:1,category:"javascript",chapter:2,type:"lesson"},fields:{slug:"/stateful-actors"}}},{node:{frontmatter:{title:"Querying",lesson:3,category:"javascript",chapter:2,type:"lesson"},fields:{slug:"/querying"}}},{node:{frontmatter:{title:"Timeouts",lesson:3,category:"javascript",chapter:3,type:"lesson"},fields:{slug:"/timeouts"}}},{node:{frontmatter:{title:"Logging and Monitoring",lesson:1,category:"javascript",chapter:4,type:"lesson"},fields:{slug:"/logging-and-monitoring"}}}]},postBySlug:{html:'<p>Actor systems are often designed around the <em>let it crash</em> philosophy.\nThis thesis is motivated by a desire to reduce the amount of infrastructural code which often obfuscates domain logic. </p>\n<p>How on earthÂ do we achieve system resilience if we just let our actors crash? The answer lies in the hierarchy: parents supervise their children. If a child crashes, the parent actor has an opportunity to make a decision about what to the fault. Erlang was one of the first platforms to adopt this strategy for dealing with faults, and was used to achieve jaw dropping reliability when building out the Ericsson telephone exchanges (on the order of nine 9s of availability). </p>\n<p>Nact\'s supervision system works similar to that of Erlang. If a child crashes in nact, it is stopped by default. Specifying the <code>whenChildCrashes</code> option allows one to override the supervision policy. A custom supervision policy is a function which takes in the exception which was thrown, the message which was being processed at the time at which the fault occurred, and the context of the parent. The supervision policy returns a decision (which may be may be asynchronous). The available decisions are enumerated in the following table:</p>\n<table class=\'definitions\'>\n    <thead>\n      <tr>\n        <th align=\'left\'>Decision</th>\n        <th align=\'left\'>Effect</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td align=\'left\'>stop</td>\n        <td align=\'left\'>Stops the faulted actor</td>\n      </tr>\n      <tr>\n        <td align=\'left\'>stopAll</td>\n        <td align=\'left\'>Stops the peers of the faulted actor</td>\n      </tr>\n      <tr>\n        <td align=\'left\'>reset</td>\n        <td align=\'left\'>Resets the state of the faulted actor</td>\n      </tr>\n      <tr>\n        <td align=\'left\'>resetAll</td>\n        <td align=\'left\'>Resets the state of the faulted actor\'s peers</td>\n      </tr>\n      <tr>\n        <td align=\'left\'>resume</td>\n        <td align=\'left\'>Continue processing the next messages in the actor\'s mailbox</td>\n      </tr>\n      <tr>\n        <td align=\'left\'>escalate</td>\n        <td align=\'left\'>Sends the fault to the grandparent of the faulted actor</td>\n      </tr>\n    </tbody>\n  </table>\n<p>Here is an example of a supervision policy which resets the faulted child each time:</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token keyword">const</span> resetChild <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> error<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> ctx<span class="token punctuation">.</span>reset<span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Perhaps your fault is caused by a resource not being available yet.\nIn that case, we don\'t want to continually restart the actor as that\'ll just waste precious CPU cycles. So we\'d change the supervision policy to delay the reset:</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token keyword">const</span> delay <span class="token operator">=</span> duration <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resetChild <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> error<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>\n    <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">500</span> <span class="token operator">-</span> <span class="token number">750</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>reset<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Perhaps we are consuming an external service and are worried about rate limiting. We could use a closure to define more sophisticated behavior:</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token keyword">const</span> delay <span class="token operator">=</span> duration <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resetFaultedChildWithExponentialDelay <span class="token operator">=</span> <span class="token punctuation">(</span>factor<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    \n    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> error<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                \n        <span class="token keyword">let</span> delay <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>factor<span class="token punctuation">;</span>\n        <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        count <span class="token operator">=</span> count<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>        \n        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>reset<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> \n</code></pre>\n      </div>\n<p>Let us modify our contacts service from the previous example to actually use the supervision policy:</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token keyword">const</span> spawnContactsService <span class="token operator">=</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">spawnStateless</span><span class="token punctuation">(</span>\n  parent<span class="token punctuation">,</span>\n  <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> userId <span class="token operator">=</span> msg<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> childActor<span class="token punctuation">;</span>\n    <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n      childActor <span class="token operator">=</span> ctx<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      childActor <span class="token operator">=</span> <span class="token function">spawnUserContactService</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>self<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>            \n    <span class="token punctuation">}</span>\n    <span class="token function">dispatch</span><span class="token punctuation">(</span>childActor<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string">\'contacts\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> whenChildCrashes<span class="token punctuation">:</span> resetChild <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>The fourth parameter to spawnStateless is the actor property object.\nThis object specifies various other behaviors of actors besides <code>whenChildCrashes</code> and will be expanded upon in later sections. </p>',timeToRead:2,excerpt:"Actor systems are often designed around the  let it crash  philosophy.\nThis thesis is motivated by a desire to reduce the amount of...",frontmatter:{title:"Supervision",cover:"https://unsplash.it/400/300/?random?BoldMage",date:"11/12/2017",category:"javascript",tags:["getting-started","nact","javascript","nodejs"]},fields:{slug:"/supervision"}}},pathContext:{slug:"/supervision",category:"javascript"}}}});
//# sourceMappingURL=path---lesson-javascript-supervision-de0e5f3e7ec392e4a323.js.map