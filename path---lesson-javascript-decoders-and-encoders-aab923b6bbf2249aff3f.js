webpackJsonp([0x8b49c067c0e8],{378:function(s,n){s.exports={data:{allPostTitles:{edges:[{node:{frontmatter:{title:"Decoders and Encoders",lesson:2,category:"javascript",chapter:4,type:"lesson"},fields:{slug:"/decoders-and-encoders"}}},{node:{frontmatter:{title:"Getting Started",lesson:2,category:"javascript",chapter:1,type:"lesson"},fields:{slug:"/getting-started"}}},{node:{frontmatter:{title:"Persist",lesson:1,category:"javascript",chapter:3,type:"lesson"},fields:{slug:"/persist"}}},{node:{frontmatter:{title:"Actor Communication",lesson:2,category:"javascript",chapter:2,type:"lesson"},fields:{slug:"/actor-communication"}}},{node:{frontmatter:{title:"Introduction",lesson:1,category:"javascript",chapter:1,type:"lesson"},fields:{slug:"/introduction"}}},{node:{frontmatter:{title:"Hierarchy",lesson:4,category:"javascript",chapter:2,type:"lesson"},fields:{slug:"/hierarchy"}}},{node:{frontmatter:{title:"Querying",lesson:3,category:"javascript",chapter:2,type:"lesson"},fields:{slug:"/querying"}}},{node:{frontmatter:{title:"Snapshotting",lesson:2,category:"javascript",chapter:3,type:"lesson"},fields:{slug:"/snapshotting"}}},{node:{frontmatter:{title:"Stateful Actors",lesson:1,category:"javascript",chapter:2,type:"lesson"},fields:{slug:"/stateful-actors"}}},{node:{frontmatter:{title:"Timeouts",lesson:3,category:"javascript",chapter:3,type:"lesson"},fields:{slug:"/timeouts"}}},{node:{frontmatter:{title:"Supervision",lesson:5,category:"javascript",chapter:2,type:"lesson"},fields:{slug:"/supervision"}}},{node:{frontmatter:{title:"Persistent Queries",lesson:4,category:"javascript",chapter:3,type:"lesson"},fields:{slug:"/persistent-queries"}}}]},postBySlug:{html:'<h2 id="schema-evolution"><a href="#schema-evolution" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Schema evolution</h2>\n<p>Evolution is a natural part of a systems lifecycle; requirements change, reality sets in and bugs are fixed.\nAs a result, migrating data from one version to another is a normal part of running a system in production.</p>\n<p>One approach to schema evolution is running some kind of batch job which upgrades the old types to the new in-place.\nThis approach is not without its risks: if done without discipline, there is the chance of data loss and other unhappy happenstances. It also goes against the philosophy of data immutability. Another downside of this approach to migration is that due to the behavior of stateful actors, an all or nothing migration may in certain circumstances, require downtime. </p>\n<p>An alternative approach which fits in with the idea of event sourcing and immutable data is lazy upgrades between schema versions</p>\n<p>For example let us imagine we have versions <code>S</code><sub><code>1</code></sub>, <code>S</code><sub><code>2</code></sub> and <code>S</code><sub><code>3</code></sub> of a schema <code>S</code>. Messages <code>m</code><sub><code>1</code></sub> and <code>m</code><sub><code>2</code></sub> were persisted with <code>S</code><sub><code>1</code></sub>, while <code>m</code><sub><code>3</code></sub> was saved with <code>S</code><sub><code>2</code></sub>. We\'ve made a change and are forced to use <code>S</code><sub><code>3</code></sub> of the schema. When replaying messages, all we need to do is define two functions: <code>S</code><sub><code>1</code></sub><code>=></code> <code>S</code><sub><code>2</code></sub> and <code>S</code><sub><code>2</code></sub><code>=></code> <code>S</code><sub><code>3</code></sub>. We apply <code>S</code><sub><code>2</code></sub><code>=></code> <code>S</code><sub><code>3</code></sub> to <code>m</code><sub><code>3</code></sub> to upgrade it to latest version of the <code>S</code>. For <code>m</code><sub><code>1,2</code></sub> we map <code>S</code><sub><code>1</code></sub><code>=></code> <code>S</code><sub><code>2</code></sub> then map from <code>S</code><sub><code>2</code></sub><code>=></code> <code>S</code><sub><code>3</code></sub> to complete the upgrade. Being able to support this strategy was the primary motivation for introducing decoders and encoders.</p>\n<h2 id="persistent-actors-and-json"><a href="#persistent-actors-and-json" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Persistent Actors and JSON</h2>\n<p>Nact uses JSON for persistence and message passing. Naïvely serializing your objects may work for a while as you are prototyping your system, however using a stable representation for your data models should very much be a concern when engineering a robust production grade system. </p>\n<p>The <code>spawnPersistent</code> function includes a number of optional arguments, namely <code>encoder</code>, <code>snapshotEncoder</code>, <code>decoder</code> and <code>snapshotDecoder</code>. These functions map deserialized JSON-safe objects to Javascript objects and map Javascript objects to JSON safe representations respectively. The decoders are well suited to performing schema evolution, while the encoders are useful for adding versioning information and creating a more stable persistent representation. </p>\n<h2 id="cracking-the-code"><a href="#cracking-the-code" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cracking the Code</h2>\n<p>The <code>DaVinci_Decode</code> example below demonstrates how to deal with an enthusiastic but naïve coworker who a) thought that <a href="https://en.wikipedia.org/wiki/ROT13">ROT<sub>13</sub></a> was a good encryption scheme and b) applied it <strong>everywhere</strong>. </p>\n<p>In the example, version zero of the message protocol is ROT13 encoded and needs to be unscrambled before\nit is processed by the actor. Version one is encoded in plain text.</p>\n<div class="gatsby-highlight">\n      <pre class="language-reason"><code><span class="token comment" spellcheck="true">/* Rot13 code */</span>\n<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token character string">\'a\'</span><span class="token punctuation">.</span>charCodeAt<span class="token punctuation">(</span><span class="token character string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> toPositionInAlphabet <span class="token operator">=</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>charCodeAt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> a<span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> fromPositionInAlphabet <span class="token operator">=</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">String</span><span class="token punctuation">.</span>fromCharCode<span class="token punctuation">(</span>c <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> rot13 <span class="token operator">=</span> str <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">...</span>str<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>chr <span class="token operator">=></span> fromPositionInAlphabet<span class="token punctuation">(</span><span class="token punctuation">(</span>toPositionInAlphabet<span class="token punctuation">(</span>chr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">13</span><span class="token punctuation">)</span> % <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token operator">\'</span><span class="token operator">\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> decoder <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>version <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    return rot13<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    return msg<span class="token punctuation">.</span>text<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> encoder <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> version<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>text <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> system <span class="token operator">=</span> start<span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* Specify a concrete persistence engine here */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> actor <span class="token operator">=</span>\n  spawnPersistent<span class="token punctuation">(</span>\n    system<span class="token punctuation">,</span>    \n    async <span class="token punctuation">(</span>state <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span>log<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>      \n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> ctx<span class="token punctuation">.</span>recovering<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        await ctx<span class="token punctuation">.</span>persist<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      return <span class="token punctuation">[</span>msg<span class="token punctuation">,</span> <span class="token operator">...</span>state<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token operator">\'</span>da<span class="token operator">-</span>vinci<span class="token operator">-</span>code<span class="token operator">\'</span><span class="token punctuation">,</span>\n    <span class="token operator">\'</span>da<span class="token operator">-</span>vinci<span class="token operator">-</span>code<span class="token operator">-</span>actor<span class="token operator">\'</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      decoder<span class="token punctuation">,</span>    \n      encoder<span class="token punctuation">,</span>\n      system      \n    <span class="token punctuation">}</span>    \n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>',timeToRead:3,excerpt:"Schema evolution Evolution is a natural part of a systems lifecycle; requirements change, reality sets in and bugs are fixed. \nAs a result...",frontmatter:{title:"Decoders and Encoders",cover:"https://unsplash.it/400/300/?random?BoldMage",date:"28/01/2018",category:"javascript",tags:["getting-started","nact","reason","bucklescript"]},fields:{slug:"/decoders-and-encoders"}}},pathContext:{slug:"/decoders-and-encoders",category:"javascript"}}}});
//# sourceMappingURL=path---lesson-javascript-decoders-and-encoders-aab923b6bbf2249aff3f.js.map